sudo: required
dist: trusty

language: python

services:
  - docker

matrix:
  include:
    - env:
      - DIST=centos
      - VERSION=6
    - env:
      - DIST=centos
      - VERSION=7
    - env:
      - DIST=ubuntu
      - VERSION=14.04
    - env:
      - DIST=ubuntu
      - VERSION=16.04

before_install:
  - docker pull ${DIST}:${VERSION}
  - docker run -w /root --name test -d ${DIST}:${VERSION} sleep infinity
  - docker cp . test:/root/
  - if [ "$DIST" == "centos" ]; then
      if [ $VERSION -eq 6 ]; then
        docker exec test rpm -Uvh http://download.jubat.us/yum/rhel/6/stable/x86_64/jubatus-release-6-2.el6.x86_64.rpm;
        docker exec test rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm;
      elif [ $VERSION -eq 7 ]; then
        docker exec test rpm -Uvh http://download.jubat.us/yum/rhel/7/stable/x86_64/jubatus-release-7-2.el7.x86_64.rpm;
      fi;
    elif [ "$DIST" == "ubuntu" ]; then
      if [ "$VERSION" == "14.04" ]; then
        docker exec test sh -c "echo 'deb http://download.jubat.us/apt/ubuntu/trusty binary/' >  /etc/apt/sources.list.d/jubatus.list";
      elif [ "$VERSION" == "16.04" ]; then
        docker exec test sh -c "echo 'deb http://download.jubat.us/apt/ubuntu/xenial binary/' >  /etc/apt/sources.list.d/jubatus.list";
      fi;
    fi

install:
  - if [ "$DIST" == "centos" ]; then
      docker exec test yum -y install gcc-c++ python-devel epel-release;
      if [ $VERSION -eq 6 ]; then
        docker exec test yum -y install centos-release-scl-rh;
        docker exec test yum -y install python27 python27-python-pip;
        docker exec test /usr/bin/scl enable python27 --pip install --upgrade pip setuptools;
      else
        docker exec test yum -y install python-pip;
        docker exec test pip install --upgrade pip;
      fi;
      if [ "$TRAVIS_BRANCH" == "master" ]; then
        docker exec test yum -y install jubatus-core-devel;
      fi;
    fi
  - if [ "$DIST" == "ubuntu" ]; then
      docker exec test apt-get -y update;
      docker exec test apt-get --force-yes -y install python-dev python-pip g++;
      docker exec test pip install --upgrade pip;
      if [ "$TRAVIS_BRANCH" == "master" ]; then
        docker exec test apt-get --force-yes -y install jubatus;
      fi;
    fi
  - if [ "$DIST" == "centos" ] && [ $VERSION -eq 6 ]; then
      docker exec test /usr/bin/scl enable python27 -- pip install jubatus cython numpy scipy;
    else
      docker exec test pip install jubatus cython numpy scipy;
    fi
  - if [ "$TRAVIS_BRANCH" != "master" ]; then
      if [ "$DIST" == "centos" ]; then
        docker exec test yum -y install git bzip2 msgpack-devel-0.5.9;
      elif [ "$DIST" == "ubuntu" ]; then
        docker exec test apt-get --force-yes -y install git bzip2 libmsgpack-dev;
      fi;
      docker exec test git clone -b develop https://github.com/jubatus/jubatus_core.git;
      if [ "$DIST" == "centos" ]; then
        docker exec test bash -ic "cd jubatus_core; ./waf configure --prefix=/usr --regexp-library=none && ./waf build && ./waf install && ldconfig";
      elif [ "$DIST" == "ubuntu" ]; then
        docker exec test bash -ic "cd jubatus_core; ./waf configure --prefix=/usr --regexp-library=none && ./waf build && ./waf install";
      fi;
    fi

script:
  - if [ "$DIST" == "centos" ]; then
      if [ $VERSION -eq 6 ]; then
        docker exec -t test /usr/bin/scl enable python27 -- bash -ic "python ./setup.py build_ext -i && python ./setup.py test";
      else
        docker exec -t test bash -ic "python ./setup.py build_ext -i && python ./setup.py test";
      fi;
    elif [ "$DIST" == "ubuntu" ]; then
      docker exec -t test bash -ic "source /opt/jubatus/profile; python ./setup.py build_ext -i && python ./setup.py test";
    fi
  - docker exec test rm -rf build
  - if [ "$DIST" == "centos" ]; then
      if [ $VERSION -eq 6 ]; then
        docker exec -t test /usr/bin/scl enable python27 -- bash -ic "python ./setup.py build_ext -i && python ./setup.py test";
      else
        docker exec -t test bash -ic "python ./setup.py build_ext -i && python ./setup.py test";
      fi;
    elif [ "$DIST" == "ubuntu" ]; then
      docker exec -t test bash -ic "source /opt/jubatus/profile; python ./setup.py build_ext -i && python ./setup.py test";
    fi
